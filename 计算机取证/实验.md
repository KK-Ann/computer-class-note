## 实验 （制作启动盘）
disk p43(非计分实验，前置实验)
- 制作带有WINPE的USB启动盘
- 网络上的制作工具：www.wepe.com.cn/老毛桃
- UEFI Boot
	- 为了后续硬盘写人，关闭secure boot
- 也可以再实验一下Legacy Boot
	- 关闭Secure Boot
	- 打开CSM, 选择LEGACY模式（传统模式）
## 实验 ：磁盘拷贝1
disk p54
- U盘启动
- WINHEX/DISK TOOLS/CLONE DISK
- 从源盘拷贝到目标盘
- c盘到u盘h （物理地址：123079376取整 123080000）
- 实验时可以选择只拷贝50000个扇区(0-49999)
- 选择USB盘为目标盘
- 选择源和目标盘的起始扇区
- 擦除源盘相应扇区内容，重启计算机 
	- 点到系统盘，在编辑处点击填充磁盘扇区，无法启动
- 将目标盘内容重新拷贝到源盘相应扇区（同上一次拷贝），重启计算机
## 实验 ：磁盘拷贝2
disk p55
- 目标选择为映像文件(U盘）
- 选择源盘的起始扇区(0-49999)
- 查看映像文件（大小、内容）
- 清空源盘相应的数据(0-49999)/ Fill Block（可以选择随机数）
- 关机重启
- 进入WINHEX，将映像文件恢复到相应扇区
- 查看0-49999扇区内容是否一致
- 重新启动看系统是否恢复
## 实验 （磁盘拷贝3）
disk p57
- 目标选择为同一磁盘的另一分区，记住该分区第一扇区位置
- 选择源盘的起始扇区(0-49999)
- 清空源盘相应的数据(0-49999)/ Fill Block
- 关机重启
- 进入WINHEX/转到记录下来的映像文件所在分区的第一个扇区
- Disk tools/Interpret as partition start（解释为分区起始）
	- 显示此分区文件
- 尝试设置该分区大小（扇区数）
- 分区就会显示出来，找到映像文件
- 打开映像文件
- Copy block / Normally
- 转到磁盘0扇区第一字节
- Clipboard data / write
- 重启计算机看系统是否恢复
## 实验（自制分区表）
partition p33 10次课末尾
- 按如下的位置制作出各个分区表:用WINHEX制作
- ![[Pasted image 20250109155332.png]]
- ![[Pasted image 20250108184111.png]]


### 知识

|           |            |            |             |
| --------- | ---------- | ---------- | ----------- |
| MBR       |            |            |             |
| 0000-01B7 | 主引导程序      |            |             |
| 01B8-01BB | 磁盘签名       |            |             |
| 01BC-01BD | 0x00, 0x00 |            |             |
| 01BE-01CD | 分区项1（16字节） | 1000       | 129,999,000 |
| 01CE-01DD | 分区项1（16字节） | 13000000   | 10,000,000  |
| 01DE-01ED | 分区项1（16字节） | 23,000,000 | 3,000,000   |
| 01EE-01FD | 分区项1（16字节） | 26,000,000 | 5,000,000   |
| 01FE      | 结束标志0x55   |            |             |
| 01FF      | 结束标志0xAA   |            |             |
分区表项

| 字节       | 内容                          |     |
| -------- | --------------------------- | --- |
| 第1字节BE   | 引导标志                        |     |
| 第2-4字节   | 本分区起始磁头号BF(、扇区号c0、柱面号C0(10) | 不重要 |
| 第5字节C2   | 本分区类型                       | 不重要 |
| 第6-8字节   | 本分区结束磁头号C3、扇区号C4、柱面号C4      | 不重要 |
| 第9-12字节  | 本分区前已用扇区数C6                 | 重要  |
| 第13-16字节 | 本分区总扇区数CA                   | 重要  |
- 分区类型
- 00H: 表示该分区未用（即没有指定）
0FH:（LBA模式）扩展分区
05H: 扩展分区；
06H: FAT16基本分区
OCH: FAT32 (LBA模式） 
07H: NTFS分区；
81H: Linux
82H: Linux交换分区
83H: Linux native file system (ext2/ext3)
![[Pasted image 20250109170317.png]]
![[Pasted image 20250109170331.png]]
![[Pasted image 20250109171216.png]]
- 扩展分区

| 1   | 65         | 1,999,935 |
| --- | ---------- | --------- |
|     | 3,000,000  | 1,000,000 |
| 2   | 78         | 999,922   |
|     | 4,000,000  | 2.000,063 |
| 3   | 63         | 2,000,000 |
|     | 7,000,000  | 3,000,000 |
| 4   | 128        | 2,999,872 |
|     | 10,000,000 | 0         |
![[Pasted image 20250110154425.png]]![[Pasted image 20250110152527.png]]
## 实验：自制GPT分区表
partition p51 11次课10：00
![[Pasted image 20250108182611.png]]
1. 按图示位置用winhex制作相应分区表
	1. 格式化硬盘，从0处套用模板GPT，填写 ![[Pasted image 20250109182903.png]]

LBA1

| 偏移  | 长度  | 内容                                                                                                |
| --- | --- | ------------------------------------------------------------------------------------------------- |
| 0   | 8   | 签名（"EFI PART", 45 46 49 20 50 41 52 54）                                                           |
| 8   | 4   | 修订版本号（在1.0一直到2017的UEFI2.7版，值都是 00 00 01 00）                                                       |
| 12  | 4   | GPT头的大小（单位是字节，通常是92字节，即 5C 00 00 00）                                                              |
| 16  | 4   | GPT头（第0－91字节）的CRC32校验(计算前需先将此内容写0)【Winhex/Tools/Compute hash】![[Pasted image 20250110004104.png]] |
| 20  | 4   | 保留，必须是 0                                                                                          |
| 24  | 8   | 当前LBA（本分区表头的位置）：备份GPT头此处通常填写最后一个扇区的LBA                                                            |
| 32  | 8   | 备份LBA（另一个分区表头的位置）：备份GPT头此处通常填写1                                                                   |
| 40  | 8   | 第一个可用于分区的LBA（主分区表的最后一个LBA + 1）                                                                    |
| 48  | 8   | 最后一个可用于分区的LBA（备份分区表的第一个LBA − 1）                                                                   |
| 56  | 16  | 硬盘GUID（在类UNIX系统中也叫UUID）                                                                           |
| 72  | 8   | 分区表项的起始LBA（在主分区表中是2，备份分区表中填写相应的位置）                                                                |
| 80  | 4   | 分区表项的数量                                                                                           |
| 84  | 4   | 一个分区表项的大小（通常是128）                                                                                 |
| 88  | 4   | CRC32 of partition array:（LBA2-33)扇区的数据做CRC32.【Winhex/Tools/Compute hash】                         |
| 92  | *   | 保留，剩余的字节必须是0（对于512B/LBA的硬盘就是420个字节）                                                               |
	LBA2-33
	- 一个扇区通常有4个分区表项，每项大小128字节
1. 将ESP格式化且写入一个文件tongji.txt，内容为tongji
2. 用winhex将该分区改成只读分区

| 起始字节 | 长度  | 内容                                                                                                                                             |
| ---- | --- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| 0    | 16  | 分区类型GUID（可用Diskgenius查看）ESP分区:28 73 2A C1 -1F F8 -D2 11- BA 4B -00 A0 C9 3E C9 3B；Window基本数据分区：A2 A0 D0 EB E5 B9 33 44 87 C0 68 B6 B7 26 99 C7 |
| 16   | 16  | 分区GUID,全局唯一标识符                                                                                                                                 |
| 32   | 8   | 起始LBA                                                                                                                                          |
| 40   | 8   | 末尾LBA                                                                                                                                          |
| 48   | 8   | 属性标签（如：bit60表示“只读”）                                                                                                                            |
| 56   | 72  | 分区名（可以包括36个UTF-16（小端序）字符）51:00                                                                                                                 |
1. 填好lba后计算哈希（扇区2-33），lba1的对应位置
2. 格式化磁盘，写入文件59:00
3. ![[Pasted image 20250110004745.png]]
## 数据区域大小：实验
filesysem p39 13次课5：46
- 计算占用簇数
	- 格式化一分区为FAT32，在分区内按后面的PPT建立一些文件和文件夹
	- 计算分区数据部分总簇数
		- 扇区：BPB(2,000,001)-36-1950-1950=1996065
		- 簇数：÷8=249508
	- FSINFO扇区查找空闲簇数：249499
		- 注：该大小一般就是WINDOWS系统在某个分区磁盘属性中的空闲空间大小
- 计算一下占用簇数，看看是否和FAT表中所指示的一样。
- 画出整个FAT分区结构图（VBR、FAT，数据区的大小和位置、占用和空闲簇数）
	- hello.txt:1簇
	- zhong：1簇
	- music：1簇
	- new.txt 3簇（4096字节1簇）
![[Pasted image 20250108214858.png]]
### 知识
![[Pasted image 20250110014647.png]]
![[Pasted image 20250110014702.png]]
- ![[Pasted image 20250110174018.png]]
- BPB
	- 分区位置和大小
	- 分区位置：由BPB: Hidden Sectors决定。指的是从MBR或EBR扇区到分区第一扇区（启动扇区）的扇区数
	- 分区大小：由BPB: Sectors (on large volumes)决定
	- FAT32系统， Sectors (on small volumes) = 0
- 一个文件通常有多个簇簇组成，如一个文件有10K，那么它占用10K/4096 = 3个簇
- 每个簇用32bits(Little Endian)编号（2开始）
	- 高四位是保留的，实际上从2-0x0FFFFFEF，因此可以表示268435438个簇
- 数据区大小（簇）：数据区大小扇区/每簇多少扇区
- FAT表项：每个表项32BITS，是Little Endian方式表示的整数，表项值是文件的下一簇
	- FAT[k]表示第K个表项（代表第K簇），FAT[0]表示第0个表项（即FAT表的0-3字节）。
	- LITTLE ENDIAN：08 00 00 00表示文件下一簇在第8簇
	- 表项高四位是保留的：例如值0x00000000和0x70000000同样表示该簇是空闲的

| FAT表中每个表项的取值            | 意义               |
| ----------------------- | ---------------- |
| 0x?00 00 00 0           | 该簇空闲             |
| 0x?0000001              | 保留值              |
| 0x?0000002 - 0x?FFFFFEF | 该簇已被占用，其值为文件的下一簇 |
| 0x?FFFFFF0 - 0x?FFFFFF6 | 保留值              |
| 0x?FFFFFF7              | 该簇损坏             |
| 0x?FFFFFF8 - 0x?FFFFFFF | 表示该簇是文件的最后一簇     |
|                         |                  |
|                         |                  |
|                         |                  |
- 目录创建时，文件系统为其分配了一个簇的空间并且将结束标记0x0FFFFFFF 写入该簇对应的FAT 表项。
- 目录即文件，文件内容即为目录项，每个目录项占用32个字节

| 偏移  | 意义                                                     |
| --- | ------------------------------------------------------ |
| 00  | 文件名  文件名必须为大写字母                                        |
| 08  | 扩展名  如果文件名和扩展名不足8和3字节，那么后面不足部分用空格填充（OX20）              |
| 0B  | 文件属性  按二进制位定义，最高两位保留未用，0-5位分别为只读位、隐藏位、系统位、卷标位、子目录位和归档位 |
| 0C  | NT保留字段                                                 |
| 0D  | 文件创建时间（精确到10毫秒）                                        |
| 0E  | 文件创建时间                                                 |
| 10  | 文件创立日期                                                 |
| 12  | 文件最新访问日期                                               |
| 14  | 文件起始簇（高16位）                                            |
| 16  | 文件最近修改时间                                               |
| 18  | 文件最近修改日期                                               |
| 1A  | 文件起始簇（低16位）                                            |
| 1C  | 文件总长度（字节数）                                             |
![[Pasted image 20250110021241.png]]
- 目录下每一个文件或者子目录占用一个目录项
- 长文件名占用多个目录项
## 实验：手动构建文件系统
filesystem p76 14 34:00
- 构建一个文件系统（如后面PPT）
	- 分区格式化（选择簇大小为4096字节）
	- 文件和目录按照指定簇和相应的顺序排列
- FAT32文件系统
	- ![[Pasted image 20250108184422.png]]
- 如何做：
	- 在WIN10下做WIN10会对分区制作造成影响，可以用DISKGENIUS将U盘脱机
	- 也可以制作分区的映像文件（可以映像分区前面部分扇区），然后将你INTERPRET AS DISK，然后对其进行操作，可以用IMDISK挂载显示制作的效果，最后将映像拷贝会U盘
	
![[Pasted image 20250110182102.png]]

|     |        |
| --- | ------ |
|     |        |
|     |        |
|     |        |
| d   | ffffff |
|     | 8      |

